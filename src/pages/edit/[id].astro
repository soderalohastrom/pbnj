---
import Layout from '@/layouts/Layout.astro';
import config from '@/lib/config';
import { isAuthenticated } from '@/lib/auth';

const { id } = Astro.params;

// Check if logged in
const isAuthed = await isAuthenticated(Astro.request, Astro.locals.runtime.env.DB, Astro.locals.runtime.env.AUTH_KEY);
if (!isAuthed) {
	return Astro.redirect('/login?return=' + encodeURIComponent(`/edit/${id}`));
}

// Fetch paste from D1 database
const runtime = Astro.locals.runtime as any;
let paste: any = null;

try {
	const result = await runtime.env.DB.prepare(
		'SELECT * FROM pastes WHERE id = ?'
	).bind(id).first();

	paste = result;
} catch (error) {
	console.error('Error fetching paste:', error);
}

if (!paste) {
	return Astro.redirect('/404');
}

// Check if paste requires a key (secret pastes are editable only by knowing the key)
if (paste.secret_key) {
	const providedKey = Astro.url.searchParams.get('key');
	if (providedKey !== paste.secret_key) {
		return Astro.redirect('/404');
	}
}
---

<Layout title={`Edit - ${config.name}`}>
	<div class="max-w-6xl mx-auto pb-12">
		<!-- Paste name input -->
		<div class="mb-4">
			<input
				type="text"
				id="name"
				class="w-full text-2xl sm:text-3xl font-bold text-paper-text"
				placeholder="Give your paste a name..."
				value={paste.name || ''}
				style="outline: none; border: none; background: transparent; padding: 0;"
			/>
		</div>

		<!-- Header row -->
		<div class="mb-3 flex items-center justify-between gap-3">
			<!-- Filename input -->
			<input
				type="text"
				id="filename"
				class="text-sm text-paper-muted truncate"
				placeholder="filename (optional)"
				value={paste.filename || ''}
				style="outline: none; border: none; flex: 1; min-width: 0; background: transparent;"
			/>

			<!-- Action buttons -->
			<div class="flex gap-3 flex-shrink-0">
				<!-- Language selector -->
				<select
					id="language"
					class="p-2 text-paper-text bg-paper-bg2 border border-paper-border rounded hover:border-paper-border-hover transition-colors cursor-pointer"
					title="Select language"
					style="outline: none;"
				>
					<option value="">auto</option>
					<option value="javascript">JS</option>
					<option value="typescript">TS</option>
					<option value="python">Python</option>
					<option value="rust">Rust</option>
					<option value="go">Go</option>
					<option value="java">Java</option>
					<option value="c">C</option>
					<option value="cpp">C++</option>
					<option value="csharp">C#</option>
					<option value="ruby">Ruby</option>
					<option value="php">PHP</option>
					<option value="swift">Swift</option>
					<option value="kotlin">Kotlin</option>
					<option value="html">HTML</option>
					<option value="css">CSS</option>
					<option value="json">JSON</option>
					<option value="yaml">YAML</option>
					<option value="markdown">MD</option>
					<option value="bash">Bash</option>
					<option value="sql">SQL</option>
					<option value="plaintext">Text</option>
				</select>

				<!-- Private toggle -->
				<button
					id="private-btn"
					class="p-2 text-paper-text bg-paper-bg2 border border-paper-border rounded hover:border-paper-border-hover transition-colors"
					title="Toggle private"
				>
					<!-- Unlocked icon (default) -->
					<svg id="lock-open" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
						<path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
					</svg>
					<!-- Locked icon (when private) -->
					<svg id="lock-closed" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
						<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
						<path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
					</svg>
				</button>

				<!-- Save button -->
				<button
					id="save-btn"
					class="p-2 text-paper-text bg-paper-bg2 border border-paper-border rounded hover:border-paper-border-hover transition-colors"
					title="Save changes"
				>
					<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
						<polyline points="17 21 17 13 7 13 7 21"></polyline>
						<polyline points="7 3 7 8 15 8"></polyline>
					</svg>
				</button>

				<!-- Cancel button -->
				<a
					href={`/${id}`}
					class="p-2 text-paper-text bg-paper-bg2 border border-paper-border rounded hover:border-paper-border-hover transition-colors"
					title="Cancel editing"
				>
					<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<line x1="18" y1="6" x2="6" y2="18"></line>
						<line x1="6" y1="6" x2="18" y2="18"></line>
					</svg>
				</a>
			</div>
		</div>

		<!-- Code editor card -->
		<div id="editor-wrapper" class="border border-paper-border rounded overflow-hidden bg-paper-bg2" style="transition: border-color 0.3s ease;">
			<textarea
				id="code-input"
				class="w-full bg-paper-bg2 text-paper-text resize-none"
				placeholder="paste your code here..."
				spellcheck="false"
				style="min-height: 480px; padding: 1.5rem; outline: none; line-height: 1.625; font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 0.875rem;"
			>{paste.code}</textarea>
		</div>
	</div>
</Layout>

<script define:vars={{ pasteId: id, pasteLanguage: paste.language, pasteIsPrivate: paste.is_private }}>
	const codeInput = document.getElementById('code-input') as HTMLTextAreaElement;
	const nameInput = document.getElementById('name') as HTMLInputElement;
	const filenameInput = document.getElementById('filename') as HTMLInputElement;
	const languageSelect = document.getElementById('language') as HTMLSelectElement;
	const privateBtn = document.getElementById('private-btn') as HTMLButtonElement;
	const lockOpen = document.getElementById('lock-open') as SVGElement;
	const lockClosed = document.getElementById('lock-closed') as SVGElement;
	const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;
	const editorWrapper = document.getElementById('editor-wrapper') as HTMLDivElement;

	let isPrivate = pasteIsPrivate === 1;

	// Set initial language value
	if (pasteLanguage) {
		languageSelect.value = pasteLanguage;
	}

	// Update private button style
	function updatePrivateButton() {
		if (isPrivate) {
			lockOpen.style.display = 'none';
			lockClosed.style.display = 'block';
		} else {
			lockOpen.style.display = 'block';
			lockClosed.style.display = 'none';
		}
	}

	// Toggle private
	privateBtn.addEventListener('click', () => {
		isPrivate = !isPrivate;
		updatePrivateButton();
	});

	// Initialize button style
	updatePrivateButton();

	function showError() {
		editorWrapper.style.borderColor = '#a63d40';
		editorWrapper.classList.add('shake');

		setTimeout(() => {
			editorWrapper.classList.remove('shake');
		}, 500);

		setTimeout(() => {
			editorWrapper.style.borderColor = 'var(--paper-border)';
		}, 2000);
	}

	async function savePaste() {
		const code = codeInput.value;
		if (!code.trim()) {
			showError();
			codeInput.focus();
			return;
		}

		saveBtn.style.opacity = '0.5';
		saveBtn.style.pointerEvents = 'none';

		try {
			const body: Record<string, any> = { code };

			if (nameInput.value.trim()) {
				body.name = nameInput.value.trim();
			}
			if (filenameInput.value.trim()) {
				body.filename = filenameInput.value.trim();
			}
			if (languageSelect.value) {
				body.language = languageSelect.value;
			}
			if (isPrivate) {
				body.private = true;
			}

			const response = await fetch(`/api/${pasteId}`, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(body),
				credentials: 'same-origin', // Include session cookie
			});

			if (!response.ok) {
				const data = await response.json().catch(() => ({}));
				throw new Error(data.error || 'Failed to save paste');
			}

			window.location.href = `/${pasteId}`;
		} catch (err: any) {
			showError();
			saveBtn.style.opacity = '1';
			saveBtn.style.pointerEvents = 'auto';
		}
	}

	saveBtn.addEventListener('click', savePaste);

	// Ctrl/Cmd + Enter or Ctrl/Cmd + S to submit
	codeInput.addEventListener('keydown', (e) => {
		if ((e.ctrlKey || e.metaKey) && (e.key === 'Enter' || e.key === 's')) {
			e.preventDefault();
			savePaste();
		}
	});

	// Global Ctrl/Cmd + S handler
	document.addEventListener('keydown', (e) => {
		if ((e.ctrlKey || e.metaKey) && e.key === 's') {
			e.preventDefault();
			savePaste();
		}
	});

	// Focus textarea on load
	codeInput.focus();
</script>

<style>
	textarea::placeholder {
		color: var(--paper-muted);
	}

	#name::placeholder {
		color: var(--paper-muted);
		opacity: 1;
	}

	#filename::placeholder {
		color: var(--paper-muted);
		opacity: 1;
	}

	@keyframes shake {
		0%, 100% { transform: translateX(0); }
		10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
		20%, 40%, 60%, 80% { transform: translateX(4px); }
	}

	.shake {
		animation: shake 0.5s ease-in-out;
	}
</style>
