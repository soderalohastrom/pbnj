---
import Layout from '@/layouts/Layout.astro';
import config from '@/lib/config';
import hljs from 'highlight.js';
import { isAuthenticated } from '@/lib/auth';

// Fetch pastes from D1 database (only if homepage is enabled)
const runtime = Astro.locals.runtime as any;
let pastes: any[] = [];

if (config.homepage) {
	try {
		// Check if user is authenticated (via session cookie or Bearer token)
		const isAuthed = await isAuthenticated(Astro.request, runtime.env.DB, runtime.env.AUTH_KEY);

		const sortDirection = config.sortOrder === 'oldest' ? 'ASC' : 'DESC';

		// If authenticated, show all pastes including private ones
		const whereClause = isAuthed ? '' : 'WHERE is_private = 0 OR is_private IS NULL';
		const { results } = await runtime.env.DB.prepare(
			`SELECT id, language, updated, filename, is_private, SUBSTR(code, 1, 200) as preview FROM pastes ${whereClause} ORDER BY updated ${sortDirection} LIMIT 20`
		).all();

		pastes = results || [];
	} catch (error) {
		console.error('Error fetching pastes:', error);
		// If there's an error or no pastes, show empty state
		pastes = [];
	}
}

function formatDate(timestamp: number): string {
	const diff = Date.now() - timestamp;
	const hours = Math.floor(diff / 3600000);
	if (hours < 1) return 'Just now';
	if (hours < 24) return `${hours} hours ago`;
	const days = Math.floor(hours / 24);
	if (days < 7) return `${days} day${days > 1 ? 's' : ''} ago`;
	const weeks = Math.floor(days / 7);
	return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
}

// Highlight preview server-side
function highlightPreview(code: string, language: string): string {
	try {
		return hljs.highlight(code, { language }).value;
	} catch {
		return hljs.highlightAuto(code).value;
	}
}
---

<Layout title={config.name}>
	<div class="max-w-6xl mx-auto pt-6 pb-12">
		<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
		{pastes.length === 0 && (
			<div class="col-span-full text-center py-12">
				<img src="/404.png" alt="No pastes yet" class="mx-auto mb-8 max-w-md w-full" />
				<p class="text-paper-muted">No pastes yet. Create your first one!</p>
			</div>
		)}
		{pastes.map((paste) => (
			<a href={`/${paste.id}`} class="group block">
				<div class="h-56 flex flex-col cursor-pointer">
					<div class="flex-1 overflow-hidden relative bg-paper-bg2 rounded preview-block">
						<pre class="m-0 p-4 overflow-hidden text-xs leading-relaxed"><code class="hljs" set:html={highlightPreview(paste.preview, paste.language)} /></pre>
						<div class="absolute bottom-0 left-0 right-0 h-16 bg-gradient-to-t from-paper-bg2 to-transparent pointer-events-none"></div>
					</div>
					<div class="py-2.5 bg-paper-bg">
						<div class="text-sm font-medium text-paper-text leading-tight mb-0.5 flex items-center gap-1.5">
							{paste.is_private === 1 && <span class="text-paper-muted" title="Private">ðŸ”’</span>}
							<span>{paste.filename || `${paste.id}.${paste.language}`}</span>
						</div>
						<div class="text-xs text-paper-muted leading-tight">
							{formatDate(paste.updated)}
						</div>
					</div>
				</div>
			</a>
		))}
		</div>
	</div>
</Layout>

<style is:global>
	.preview-block pre {
		background: transparent !important;
	}
	.preview-block code {
		font-family: 'SF Mono', Monaco, 'Courier New', monospace;
	}
</style>
