---
import Layout from '@/layouts/Layout.astro';
import config from '@/lib/config';
---

<Layout title={`Login - ${config.name}`}>
	<div class="flex flex-col items-center" style="justify-content: center; width: 100%; min-height: calc(100vh - 180px);">
		<img src="/lock.png" alt="Lock" style="width: 120px; height: auto; margin-bottom: 48px;" />
		<div id="auth-wrapper" class="bg-paper-bg2 rounded-lg p-2 shadow-sm flex items-center gap-3" style="width: min(320px, calc(100% - 32px)); border: 2px solid transparent; transition: border-color 0.3s ease;">
			<input
				type="password"
				id="auth-key"
				class="flex-1 px-3 py-2 bg-paper-bg2 text-paper-text placeholder-paper-muted focus:outline-none focus:ring-0"
				placeholder="enter your auth key"
				autocomplete="off"
			/>
			<button
				id="continue-btn"
				class="w-12 h-10 bg-paper-bg2 text-paper-text rounded-md font-medium hover:opacity-80 transition-opacity flex items-center justify-center"
			>
				<span style="font-size: 28px;">â€º</span>
			</button>
		</div>
	</div>
</Layout>

<script>
	const input = document.getElementById('auth-key') as HTMLInputElement;
	const button = document.getElementById('continue-btn') as HTMLButtonElement;
	const wrapper = document.getElementById('auth-wrapper') as HTMLDivElement;

	// Get return URL from query params
	const urlParams = new URLSearchParams(window.location.search);
	const returnUrl = urlParams.get('return') || '/';

	// Check if already logged in
	const isLoggedIn = localStorage.getItem('pbnj_logged_in');
	if (isLoggedIn) {
		window.location.href = returnUrl;
	}

	function showError() {
		// Add red border and shake
		wrapper.style.borderColor = '#a63d40';
		wrapper.classList.add('shake');

		// Remove shake class after animation
		setTimeout(() => {
			wrapper.classList.remove('shake');
		}, 500);

		// Remove red border after 2 seconds
		setTimeout(() => {
			wrapper.style.borderColor = 'transparent';
		}, 2000);
	}

	async function validateAndRedirect() {
		const key = input.value.trim();
		if (!key) return;

		button.style.opacity = '0.5';
		button.style.pointerEvents = 'none';

		try {
			// Login and create session
			const response = await fetch('/api/auth/login', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ key }),
			});

			if (response.ok) {
				// Store flag for UI state (not the actual key)
				localStorage.setItem('pbnj_logged_in', 'true');
				window.location.href = returnUrl;
			} else {
				showError();
				button.style.opacity = '1';
				button.style.pointerEvents = 'auto';
			}
		} catch (err) {
			showError();
			button.style.opacity = '1';
			button.style.pointerEvents = 'auto';
		}
	}

	button.addEventListener('click', validateAndRedirect);

	input.addEventListener('keydown', (e) => {
		if (e.key === 'Enter') {
			validateAndRedirect();
		}
	});

	// Focus input on load
	input.focus();
</script>

<style>
	#auth-key:focus {
		outline: none !important;
		box-shadow: none !important;
	}

	@keyframes shake {
		0%, 100% { transform: translateX(0); }
		10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
		20%, 40%, 60%, 80% { transform: translateX(4px); }
	}

	.shake {
		animation: shake 0.5s ease-in-out;
	}
</style>
